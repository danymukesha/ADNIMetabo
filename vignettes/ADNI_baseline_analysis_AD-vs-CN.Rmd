---
title: "ADNI Baseline Analysis: Alzheimer's Disease vs Cognitively Normal"
subtitle: "Case-Control Study
author: "Analysis Report"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    code_folding: hide
    fig_width: 10
    fig_height: 6
  pdf_document:
    toc: true
    fig_width: 8
    fig_height: 5
vignette: >
  %\VignetteIndexEntry{ADNI_baseline_analysis_AD-vs-CN}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE, 
    warning = FALSE, 
    message = FALSE, 
    fig.align = "center", 
    dpi = 300)

library(tidyverse)
library(ggplot2)
library(gridExtra)
library(corrplot)
library(tableone)
library(RColorBrewer)
library(viridis)
library(plotly)
library(DT)
library(kableExtra)
library(ggpubr)
library(broom)
library(car)
library(effsize)
devtools::load_all()

theme_set(#theme_minimal() + 
          theme(plot.title = element_text(hjust = 0.5, face = "bold"),
                legend.position = "bottom"))

custom_colors <- c("#2E86AB", "#A23B72", "#F18F01", "#C73E1D")
```

# Executive Summary

This analysis examines baseline differences between Alzheimer's Disease (AD) patients and Cognitively Normal (CN) controls in the ADNI dataset. The study includes demographic, clinical, neuropsychological, and biomarker comparisons.

# Data Preparation

```{r data-prep}
# baseline subset for case-control analysis
baseline_data <- adnim %>%
  filter(VISCODE == "bl", DX_bl %in% c("AD", "CN")) %>%
  mutate(
    Group = factor(DX_bl, levels = c("CN", "AD")),
    APOE4_status = case_when(
      APOE4 == 0 ~ "No APOE4",
      APOE4 == 1 ~ "One APOE4",
      APOE4 == 2 ~ "Two APOE4",
      TRUE ~ "Unknown"
    ),
    Education_level = case_when(
      PTEDUCAT < 12 ~ "< High School",
      PTEDUCAT == 12 ~ "High School",
      PTEDUCAT > 12 & PTEDUCAT < 16 ~ "Some College",
      PTEDUCAT >= 16 ~ "College+",
      TRUE ~ "Unknown"
    ),
    # Convert biomarker strings to numeric
    ABETA_numeric = as.numeric(ifelse(ABETA_bl == "", NA, ABETA_bl)),
    TAU_numeric = as.numeric(ifelse(TAU_bl == "", NA, TAU_bl))
  ) %>%
  select(-ABETA_bl, -TAU_bl, -ABETA, -TAU) # Remove string versions

# Summary of sample sizes
cat("Sample Sizes:\n")
table(baseline_data$Group)
```

# Demographic Characteristics

## Table 1: Baseline Demographics and Clinical Characteristics

```{r demographics-table}
demo_vars <- c("AGE", "PTGENDER", "PTEDUCAT", "Education_level", 
               "APOE4", "APOE4_status")

tab1 <- CreateTableOne(vars = demo_vars, 
                       strata = "Group", 
                       data = baseline_data,
                       test = TRUE)

kable(print(tab1, showAllLevels = TRUE, printToggle = FALSE), 
      caption = "Table 1: Baseline Demographics") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

## Demographic Visualizations

```{r demo-plots, fig.height=8, fig.width=12}
p1 <- ggplot(baseline_data, aes(x = Group, y = AGE, fill = Group)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.3) +
  scale_fill_manual(values = custom_colors[1:2]) +
  labs(title = "Age Distribution by Group", y = "Age (years)") +
  theme(legend.position = "none")

p2 <- baseline_data %>%
  count(Group, PTGENDER) %>%
  group_by(Group) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = Group, y = prop, fill = PTGENDER)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = custom_colors[3:4]) +
  labs(title = "Gender Distribution by Group", y = "Proportion", fill = "Gender")

p3 <- baseline_data %>%
  count(Group, Education_level) %>%
  ggplot(aes(x = Education_level, y = n, fill = Group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = custom_colors[1:2]) +
  labs(title = "Education Distribution by Group", 
       x = "Education Level", y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

p4 <- baseline_data %>%
  count(Group, APOE4_status) %>%
  group_by(Group) %>%
  mutate(prop = n / sum(n)) %>%
  ggplot(aes(x = APOE4_status, y = prop, fill = Group)) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = custom_colors[1:2]) +
  labs(title = "APOE4 Status Distribution by Group", 
       x = "APOE4 Status", y = "Proportion") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

grid.arrange(p1, p2, p3, p4, ncol = 2)
```

# Neuropsychological Assessment Comparisons

## Table 2: Cognitive Test Scores

```{r cognitive-table}
cog_vars <- c("MMSE_bl", "ADAS11_bl", "ADAS13_bl", "ADASQ4_bl", 
              "LDELTOTAL_BL", "RAVLT_immediate_bl", "RAVLT_learning_bl", 
              "RAVLT_forgetting_bl", "MOCA_bl")

tab2 <- CreateTableOne(vars = cog_vars, 
                       strata = "Group", 
                       data = baseline_data,
                       test = TRUE)

kable(print(tab2, printToggle = FALSE), 
      caption = "Table 2: Neuropsychological Assessment Scores") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

## Cognitive Assessment Visualizations

```{r cognitive-plots, fig.height=10, fig.width=14}
cog_data <- baseline_data %>%
  select(Group, all_of(cog_vars)) %>%
  gather(key = "Test", value = "Score", -Group) %>%
  filter(!is.na(Score)) %>%
  mutate(
    Test_Label = case_when(
      Test == "MMSE_bl" ~ "MMSE",
      Test == "ADAS11_bl" ~ "ADAS-11",
      Test == "ADAS13_bl" ~ "ADAS-13", 
      Test == "ADASQ4_bl" ~ "ADAS-Q4",
      Test == "LDELTOTAL_BL" ~ "Logical Memory",
      Test == "RAVLT_immediate_bl" ~ "RAVLT Immediate",
      Test == "RAVLT_learning_bl" ~ "RAVLT Learning",
      Test == "RAVLT_forgetting_bl" ~ "RAVLT Forgetting",
      Test == "MOCA_bl" ~ "MOCA",
      TRUE ~ Test
    )
  )

ggplot(cog_data, aes(x = Group, y = Score, fill = Group)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 0.5) +
  scale_fill_manual(values = custom_colors[1:2]) +
  facet_wrap(~ Test_Label, scales = "free_y", ncol = 3) +
  labs(title = "Cognitive Test Scores by Group", 
       y = "Score") +
  theme(legend.position = "none", 
        strip.text = element_text(face = "bold"))
```

## Effect Sizes for Cognitive Tests

```{r effect-sizes}
# Calculate effect sizes (Cohen's d)
effect_sizes <- cog_data %>%
  group_by(Test_Label) %>%
  summarise(
    cohens_d = cohen.d(Score ~ Group, na.rm = TRUE)$estimate,
    ci_lower = cohen.d(Score ~ Group, na.rm = TRUE)$conf.int[1],
    ci_upper = cohen.d(Score ~ Group, na.rm = TRUE)$conf.int[2],
    p_value = t.test(Score ~ Group, na.rm = TRUE)$p.value,
    .groups = 'drop'
  ) %>%
  arrange(desc(abs(cohens_d)))

# Plot effect sizes
ggplot(effect_sizes, aes(x = reorder(Test_Label, abs(cohens_d)), y = cohens_d)) +
  geom_col(aes(fill = abs(cohens_d) > 0.8), alpha = 0.8) +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.2) +
  coord_flip() +
  scale_fill_manual(values = c("FALSE" = custom_colors[1], "TRUE" = custom_colors[2]),
                   name = "Large Effect\n(|d| > 0.8)") +
  labs(title = "Effect Sizes (Cohen's d) for Cognitive Tests", 
       subtitle = "AD vs CN Comparison",
       x = "Cognitive Test", y = "Cohen's d (95% CI)") +
  geom_hline(yintercept = c(-0.8, -0.5, -0.2, 0.2, 0.5, 0.8), 
             linetype = "dashed", alpha = 0.5)

kable(effect_sizes, digits = 3, 
      caption = "Effect Sizes for Cognitive Test Differences") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

# Biomarker Analysis

## Table 3: Biomarker Comparisons

```{r biomarker-table}
bio_vars <- c("FDG_bl", "AV45_bl", "ABETA_numeric", "TAU_numeric", "ICV_bl")

tab3 <- CreateTableOne(vars = bio_vars, 
                       strata = "Group", 
                       data = baseline_data,
                       test = TRUE)

kable(print(tab3, printToggle = FALSE), 
      caption = "Table 3: Biomarker Comparisons") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

## Biomarker Visualizations

```{r biomarker-plots, fig.height=8, fig.width=12}
bio_data <- baseline_data %>%
  select(Group, FDG_bl, AV45_bl, ABETA_numeric, TAU_numeric) %>%
  gather(key = "Biomarker", value = "Value", -Group) %>%
  filter(!is.na(Value)) %>%
  mutate(
    Biomarker_Label = case_when(
      Biomarker == "FDG_bl" ~ "FDG-PET",
      Biomarker == "AV45_bl" ~ "Amyloid PET",
      Biomarker == "ABETA_numeric" ~ "CSF Aβ42",
      Biomarker == "TAU_numeric" ~ "CSF Tau",
      TRUE ~ Biomarker
    )
  )

p1 <- ggplot(bio_data, aes(x = Group, y = Value, fill = Group)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.3, size = 0.5) +
  scale_fill_manual(values = custom_colors[1:2]) +
  facet_wrap(~ Biomarker_Label, scales = "free_y", ncol = 2) +
  labs(title = "Biomarker Levels by Group", y = "Value") +
  theme(legend.position = "none")

print(p1)

bio_corr_data <- baseline_data %>%
  select(FDG_bl, AV45_bl, ABETA_numeric, TAU_numeric) %>%
  rename("FDG-PET" = FDG_bl, 
         "Amyloid PET" = AV45_bl,
         "CSF Aβ42" = ABETA_numeric,
         "CSF Tau" = TAU_numeric)

corrplot(cor(bio_corr_data, use = "complete.obs"), 
         method = "color", type = "upper", 
         title = "Biomarker Correlations",
         mar = c(0,0,2,0))
```

# Statistical Modeling

## Logistic Regression: Predictors of AD Diagnosis

```{r logistic-regression}
# data for modeling (complete cases only)
model_data <- baseline_data %>%
  select(Group, AGE, Male, PTEDUCAT, APOE4_1, APOE4_2,
         MMSE_bl, ADAS11_bl, FDG_bl, ABETA_numeric, TAU_numeric) %>%
  mutate(AD = ifelse(Group == "AD", 1, 0)) %>%
  na.omit()

cat("Model data dimensions:", dim(model_data), "\n")

# Univariate models
uni_vars <- c("AGE", "Male", "PTEDUCAT", "APOE4_1", "APOE4_2", 
              "MMSE_bl", "ADAS11_bl", "FDG_bl", "ABETA_numeric", "TAU_numeric")

uni_results <- map_dfr(uni_vars, ~{
  formula_str <- paste("AD ~", .x)
  model <- glm(as.formula(formula_str), data = model_data, family = "binomial")
  tidy(model) %>%
    filter(term == .x) %>%
    mutate(variable = .x)
})

# Multivariate model
multi_model <- glm(AD ~ AGE + Male + PTEDUCAT + APOE4_1 + APOE4_2 + 
                   MMSE_bl + ADAS11_bl + FDG_bl + ABETA_numeric + TAU_numeric,
                   data = model_data, family = "binomial")

multi_results <- tidy(multi_model) %>%
  filter(term != "(Intercept)") %>%
  mutate(
    OR = exp(estimate),
    CI_lower = exp(estimate - 1.96 * std.error),
    CI_upper = exp(estimate + 1.96 * std.error)
  )

kable(multi_results %>% 
      select(term, OR, CI_lower, CI_upper, p.value) %>%
      mutate(across(where(is.numeric), round, 3)),
      caption = "Multivariate Logistic Regression Results",
      col.names = c("Variable", "OR", "95% CI Lower", "95% CI Upper", "p-value")) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

cat("Model AUC:", pROC::auc(pROC::roc(model_data$AD, predict(multi_model, type = "response"))), "\n")
```

## Forest Plot of Odds Ratios

```{r forest-plot, fig.height=8, fig.width=10}
forest_data <- multi_results %>%
  mutate(
    Variable_Label = case_when(
      term == "AGE" ~ "Age (per year)",
      term == "Male" ~ "Male gender",
      term == "PTEDUCAT" ~ "Education (per year)",
      term == "APOE4_1" ~ "APOE4 (1 allele)",
      term == "APOE4_2" ~ "APOE4 (2 alleles)",
      term == "MMSE_bl" ~ "MMSE score",
      term == "ADAS11_bl" ~ "ADAS-11 score",
      term == "FDG_bl" ~ "FDG-PET",
      term == "ABETA_numeric" ~ "CSF Aβ42",
      term == "TAU_numeric" ~ "CSF Tau",
      TRUE ~ term
    ),
    Significant = ifelse(p.value < 0.05, "Significant", "Non-significant")
  )

ggplot(forest_data, aes(x = reorder(Variable_Label, OR), y = OR)) +
  geom_point(aes(color = Significant), size = 3) +
  geom_errorbar(aes(ymin = CI_lower, ymax = CI_upper, color = Significant), 
                width = 0.2) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  coord_flip() +
  scale_color_manual(values = c("Significant" = custom_colors[2], 
                               "Non-significant" = custom_colors[1])) +
  scale_y_log10() +
  labs(title = "Forest Plot: Odds Ratios for AD Diagnosis",
       subtitle = "Multivariate Logistic Regression Model",
       x = "Variable", y = "Odds Ratio (95% CI, log scale)") +
  theme(legend.title = element_blank())
```

# Advanced Visualizations

## Principal Component Analysis

```{r pca-analysis, fig.height=8, fig.width=12}
# PCA on cognitive and biomarker variables
pca_data <- baseline_data %>%
  select(Group, MMSE_bl, ADAS11_bl, ADAS13_bl, LDELTOTAL_BL,
         RAVLT_immediate_bl, FDG_bl, ABETA_numeric, TAU_numeric) %>%
  na.omit()

# Perform PCA
pca_result <- prcomp(pca_data[,-1], scale = TRUE, center = TRUE)

# PCA plot
pca_df <- data.frame(pca_result$x) %>%
  mutate(Group = pca_data$Group)

p1 <- ggplot(pca_df, aes(x = PC1, y = PC2, color = Group)) +
  geom_point(alpha = 0.6, size = 2) +
  stat_ellipse(type = "norm", linetype = 2) +
  scale_color_manual(values = custom_colors[1:2]) +
  labs(title = "Principal Component Analysis",
       subtitle = "Cognitive and Biomarker Variables",
       x = paste0("PC1 (", round(summary(pca_result)$importance[2,1]*100, 1), "%)"),
       y = paste0("PC2 (", round(summary(pca_result)$importance[2,2]*100, 1), "%)"))

# Scree plot
scree_data <- data.frame(
  PC = 1:length(pca_result$sdev),
  Variance = pca_result$sdev^2 / sum(pca_result$sdev^2)
)

p2 <- ggplot(scree_data, aes(x = PC, y = Variance)) +
  geom_col(fill = custom_colors[3], alpha = 0.7) +
  geom_line(group = 1) +
  geom_point() +
  labs(title = "Scree Plot", y = "Proportion of Variance", x = "Principal Component")

grid.arrange(p1, p2, ncol = 2)

# Variable loadings
loadings_df <- data.frame(pca_result$rotation[,1:2]) %>%
  rownames_to_column("Variable") %>%
  mutate(
    Variable_Label = case_when(
      Variable == "MMSE_bl" ~ "MMSE",
      Variable == "ADAS11_bl" ~ "ADAS-11",
      Variable == "ADAS13_bl" ~ "ADAS-13",
      Variable == "LDELTOTAL_BL" ~ "Logical Memory",
      Variable == "RAVLT_immediate_bl" ~ "RAVLT Immediate",
      Variable == "FDG_bl" ~ "FDG-PET",
      Variable == "ABETA_numeric" ~ "CSF Aβ42",
      Variable == "TAU_numeric" ~ "CSF Tau",
      TRUE ~ Variable
    )
  )

# Biplot
ggplot() +
  geom_point(data = pca_df, aes(x = PC1, y = PC2, color = Group), alpha = 0.6) +
  geom_segment(data = loadings_df, 
               aes(x = 0, y = 0, xend = PC1*5, yend = PC2*5),
               arrow = arrow(length = unit(0.3, "cm")), color = "red") +
  geom_text(data = loadings_df, 
            aes(x = PC1*5.5, y = PC2*5.5, label = Variable_Label),
            size = 3, color = "red") +
  scale_color_manual(values = custom_colors[1:2]) +
  labs(title = "PCA Biplot", 
       subtitle = "Variables (red) and Individuals (colored by group)")
```

# Summary and Conclusions

```{r summary-stats}
# Summary statistics
cat("Key Findings:\n")
cat("=============\n\n")

# Sample sizes
n_ad <- sum(baseline_data$Group == "AD", na.rm = TRUE)
n_cn <- sum(baseline_data$Group == "CN", na.rm = TRUE)
cat("Sample Sizes: AD =", n_ad, ", CN =", n_cn, "\n\n")

# Age comparison
age_test <- t.test(AGE ~ Group, data = baseline_data)
cat("Age: AD patients are significantly older than CN controls\n")
cat("  Mean difference:", round(age_test$estimate[1] - age_test$estimate[2], 1), "years\n")
cat("  p-value:", format.pval(age_test$p.value, digits = 3), "\n\n")

# MMSE comparison
mmse_test <- t.test(MMSE_bl ~ Group, data = baseline_data)
cat("MMSE: AD patients have significantly lower scores\n")
cat("  Mean difference:", round(mmse_test$estimate[2] - mmse_test$estimate[1], 1), "points\n")
cat("  p-value:", format.pval(mmse_test$p.value, digits = 3), "\n\n")

# APOE4 association
apoe_test <- chisq.test(table(baseline_data$Group, baseline_data$APOE4))
cat("APOE4: Significantly associated with AD diagnosis\n")
cat("  Chi-square p-value:", format.pval(apoe_test$p.value, digits = 3), "\n")
```

## Key Statistical Differences

The analysis reveals significant differences between AD patients and CN controls across multiple domains:

**Demographics:**
- AD patients are significantly older than CN controls
- Higher proportion of APOE4 carriers in AD group
- No significant gender differences

**Cognitive Function:**
- AD patients show severe impairment on all cognitive measures
- Largest effect sizes observed for ADAS scores and memory tests
- MMSE scores clearly differentiate the groups

**Biomarkers:**
- Lower CSF Aβ42 levels in AD patients
- Higher CSF Tau levels in AD patients  
- Reduced FDG-PET metabolism in AD group

**Clinical Implications:**
The multivariate model identifies key predictors of AD diagnosis, with cognitive measures and biomarkers showing the strongest associations. These findings support the use of combined cognitive and biomarker assessments for AD diagnosis and monitoring.

---

*Analysis completed on `r Sys.Date()`*
*Data source: ADNI (Alzheimer's Disease Neuroimaging Initiative)*
